const F_PK='firebaseUserProfileData',D_PI='https://cdn-icons-png.flaticon.com/512/3135/3135715.png',F_SV='11.6.1';
let a=null,b=null,c=!1,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;

function v(){const w=document.getElementById("json:firebaseconfig");if(!w)return null;try{const x=JSON.parse(w.textContent);if(x&&x.apiKey&&(x.appId||x.projectId))return{apiKey:x.apiKey,authDomain:x.authDomain,projectId:x.projectId,databaseURL:x.databaseURL,storageBucket:x.storageBucket,messagingSenderId:x.messagingSenderId,appId:x.appId}}catch(x){console.error("Failed to parse Firebase config:",x)}return null}

async function w(){if(c)return;const x=v();if(!x)return console.warn("Firebase config missing. Auth features skipped."),C(!1,null,null),D(),void(d&&(d.checked=!1));try{const[y,z]=await Promise.all([import(`https://www.gstatic.com/firebasejs/${F_SV}/firebase-app.js`),import(`https://www.gstatic.com/firebasejs/${F_SV}/firebase-auth.js`)]);const{initializeApp:A,getApps:B,getApp:C}=y,{getAuth:D,onAuthStateChanged:E,signOut:F}=z;const G=B();b=G.length===0?A(x):C(),a=D(b),c=!0,E(a,x=>{x?H(x):I(),d&&(d.checked=!1)}),l&&(l.removeEventListener("click",x),l.addEventListener("click",()=>J(a,F)))}catch(x){console.error("Firebase init failed:",x),C(!1,null,null),D(),d&&(d.checked=!1)}}

function H(x){console.log("User logged in:",x.uid);const y={uid:x.uid,displayName:x.displayName,photoURL:x.photoURL,email:x.email};let z=null;try{const A=localStorage.getItem(F_PK);z=A?JSON.parse(A):null}catch(x){console.error("Failed to parse cached data:",x)}const A={...z,...y,isAdmin:z?z.isAdmin:!1};localStorage.setItem(F_PK,JSON.stringify(A)),C(!0,A,A.photoURL||x.photoURL)}

function I(){console.log("User logged out."),localStorage.removeItem(F_PK),C(!1,null,null),D()}

function J(x,y){const z=()=>{console.log("Post-logout cleanup."),d&&(d.checked=!1),window.location.href="/p/login.html"};if(!x)return console.warn("Firebase Auth unavailable."),localStorage.removeItem(F_PK),C(!1,null,null),void z();y(x).then(()=>{console.log("SignOut successful."),z()}).catch(A=>{console.error("Logout failed:",A),z()})}

function C(x,y,z){if(!h||!i)return;if(x){h.classList.add("hidden"),i.classList.remove("hidden");const A=y&&!0===y.isAdmin;j&&j.classList.toggle("hidden",!A),k&&k.classList.toggle("hidden",A),m&&m.classList.toggle("hidden",A),l&&l.classList.toggle("hidden",A),e&&(function(x,y,z){let A=x.querySelector(".current-profile-image");const B=y||D_PI;if(!A){x.innerHTML="",A=document.createElement("img"),A.alt="Profile",A.classList.add("profileUser","current-profile-image"),x.appendChild(A),A.onerror=function(){this.src=D_PI}}A.src=B,x.classList.add("logged-in")}(e,z))}else{h.classList.remove("hidden"),i.classList.add("hidden"),j&&j.classList.add("hidden"),k&&k.classList.add("hidden"),m&&m.classList.add("hidden"),l&&l.classList.add("hidden"),e&&(e.innerHTML=n,e.classList.remove("logged-in"))}}

function D(){const x=localStorage.getItem("prompt_dismissed_v13");const y=Date.now();if(x){try{const z=JSON.parse(x);const A=(y-z.timestamp)/(1e3*60*60*24);if(A<3.5)return}catch(x){console.error("Error parsing dismissal data:",x)}}const z="undefined"!=typeof data&&data.blog?.title?data.blog.title:"صوانˣʸᶻ",A="undefined"!=typeof data&&data.blog?.blogspotFaviconUrl?data.blog.blogspotFaviconUrl:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh80X00Lvdk3ZJBmgQFmGd1SmDZvqHpPf8D6YhmW7QsWYXyo_Cbo6BFHHdv1r1ocOe4gr5OexjPYYi-9Tp6QFQsfci2WPbFDu6DGFFr4UzhyphenhyphenkbTKFEBEQyPPbuYDM08v9-OU4ySBsI4bNOPtqr-U1fKMmcqRL38XSVE_XvVjFcblgVffq1j18GvYQTZEM8/s1600/favicon.png";let B=document.getElementById("login-signup-prompt-dynamic");if(!B){const C=document.createElement("div");C.innerHTML=`<div id="login-signup-prompt-dynamic" class="browser-notification-bar" style="position:fixed;top:58px;left:0;right:0;margin:0 auto;z-index:10000;max-width:650px;width:95%;background:rgba(255,255,255,0.98);border:1px solid rgba(0,0,0,0.1);border-radius:8px;padding:18px;display:none;font-family:system-ui;direction:rtl;backdrop-filter:blur(12px);transform:translateY(-100%);opacity:0;transition:opacity 0.4s,transform 0.4s;"><div class="prompt-content" style="display:flex;justify-content:space-between;align-items:center;"><div class="site-info" style="display:flex;align-items:center;flex-grow:1;min-width:0;"><img src="${A}" alt="${z} icon" style="width:32px;height:32px;border-radius:8px;margin-left:12px;object-fit:contain;"/><div class="text-block" style="display:flex;flex-direction:column;min-width:0;text-align:right;"><p class="site-name" style="font-size:0.95em;font-weight:600;margin:0 0 2px 0;color:#1a1a1a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${z}</p><p class="prompt-message" style="font-size:0.85em;color:#6a6a6a;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">هل أنت جديد هنا؟ سجل الدخول أو أنشئ حسابًا.</p></div></div><div dir="ltr" class="prompt-actions" style="display:flex;gap:10px;flex-shrink:0;"><a href="/p/login.html" class="action-button" style="background:#007aff;color:white;padding:9px 16px;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.9em;white-space:nowrap;">تسجيل الدخول</a><button id="dismiss-prompt-dynamic" class="secondary-button" style="background:none;border:none;color:#6a6a6a;padding:9px 16px;font-size:0.9em;cursor:pointer;border-radius:8px;opacity:0.8;transition:all 0.3s;">ليس الآن</button></div></div></div>`.trim(),B=C.firstElementChild,document.body.appendChild(B)}const E=document.getElementById("dismiss-prompt-dynamic");setTimeout(()=>{B.style.display="block",setTimeout(()=>{B.classList.add("show")},50)},5e3),E.addEventListener("click",()=>{B.classList.remove("show"),setTimeout(()=>{B.parentNode&&B.parentNode.removeChild(B)},400);const x={timestamp:y,version:"v13"};localStorage.setItem("prompt_dismissed_v13",JSON.stringify(x))},{once:!0})}

function K(){e&&d&&e.addEventListener("click",x=>{x.preventDefault(),d.checked=!d.checked}),document.addEventListener("click",x=>{const y=x.target;if(d&&d.checked&&e&&f){const z=e.contains(y)||f.contains(y);z||(d.checked=!1)}}),j&&j.addEventListener("click",()=>window.location.href="/p/admin.html"),k&&k.addEventListener("click",x=>{x.preventDefault(),window.location.href="/p/points.html"}),m&&m.addEventListener("click",x=>{x.preventDefault(),window.location.href="/p/my-products.html"})}

document.addEventListener("DOMContentLoaded",()=>{d=document.getElementById("forlogPop"),e=document.querySelector(".logReg"),f=document.querySelector(".logPop-wrp"),h=document.querySelector(".NotLog"),i=document.querySelector(".DonLog"),i&&(j=i.querySelector('div.loginS[aria-label="ادمن"]'),k=i.querySelector('a.loginS[aria-label="نقاطي"]'),l=i.querySelector('div.loginS[aria-label="الخروج"]'),m=i.querySelector('a.loginS[aria-label="منتجاتي"]'),o=i.querySelector('a.loginS[aria-label="الإعدادات"]'),p=i.querySelector('a.loginS[aria-label="المفضلة"]'),q=i.querySelector('a.loginS[aria-label="المحادثات"]'),r=i.querySelector('a.loginS[aria-label="التنبيهات"]'),s=i.querySelector('a.loginS[aria-label="المساعدة"]'),t=i.querySelector('a.loginS[aria-label="التقييم"]'),u=i.querySelector('a.loginS[aria-label="حول"]')),n=e?e.innerHTML:"",K(),w()});
