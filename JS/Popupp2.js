const F_PK='firebaseUserProfileData',D_PI='https://cdn-icons-png.flaticon.com/512/3135/3135715.png',F_SV='11.6.1';
let a=null,b=null,c=!1,d,e,f,g,h,i,j,k,l,m;

function n(){const o=document.getElementById("json:firebaseconfig");if(!o)return null;try{const p=JSON.parse(o.textContent);if(p&&p.apiKey&&(p.appId||p.projectId))return{apiKey:p.apiKey,authDomain:p.authDomain,projectId:p.projectId,databaseURL:p.databaseURL,storageBucket:p.storageBucket,messagingSenderId:p.messagingSenderId,appId:p.appId}}catch(p){console.error("Failed to parse Firebase config:",p)}return null}

async function o(){if(c)return;const p=n();if(!p)return console.warn("Firebase config missing. Auth features skipped."),C(!1,null,null),D(),void(d&&(d.checked=!1));try{const[q,r]=await Promise.all([import(`https://www.gstatic.com/firebasejs/${F_SV}/firebase-app.js`),import(`https://www.gstatic.com/firebasejs/${F_SV}/firebase-auth.js`)]);const{initializeApp:s,getApps:t,getApp:u}=q,{getAuth:v,onAuthStateChanged:w,signOut:x}=r;const y=t();b=y.length===0?s(p):u(),a=v(b),c=!0,w(a,p=>{p?z(p):A(),d&&(d.checked=!1)}),k&&k.addEventListener("click",()=>B(a,x))}catch(p){console.error("Firebase init failed:",p),C(!1,null,null),D(),d&&(d.checked=!1)}}

function z(p){console.log("User logged in:",p.uid);const q={uid:p.uid,displayName:p.displayName,photoURL:p.photoURL,email:p.email};let r=null;try{const s=localStorage.getItem(F_PK);r=s?JSON.parse(s):null}catch(p){console.error("Failed to parse cached data:",p)}const s={...r,...q,isAdmin:r?r.isAdmin:!1};localStorage.setItem(F_PK,JSON.stringify(s)),C(!0,s,s.photoURL||p.photoURL)}

function A(){console.log("User logged out."),localStorage.removeItem(F_PK),C(!1,null,null),D()}

function B(p,q){const r=()=>{console.log("Post-logout cleanup."),d&&(d.checked=!1),window.location.href="/p/login.html"};if(!p)return console.warn("Firebase Auth unavailable."),localStorage.removeItem(F_PK),C(!1,null,null),void r();q(p).then(()=>{console.log("SignOut successful."),r()}).catch(s=>{console.error("Logout failed:",s),r()})}

function C(p,q,r){if(!h||!i)return;if(p){h.classList.add("hidden"),i.classList.remove("hidden");const s=q&&!0===q.isAdmin;j&&j.classList.toggle("hidden",!s),l&&l.classList.toggle("hidden",s),k&&k.classList.toggle("hidden",s),e&&(function(p,q,r){let s=p.querySelector(".current-profile-image");const t=q||D_PI;if(!s){p.innerHTML="",s=document.createElement("img"),s.alt="Profile",s.classList.add("profileUser","current-profile-image"),p.appendChild(s),s.onerror=function(){this.src=D_PI}}s.src=t,p.classList.add("logged-in")}(e,r))}else{h.classList.remove("hidden"),i.classList.add("hidden"),j&&j.classList.add("hidden"),l&&l.classList.add("hidden"),k&&k.classList.add("hidden"),e&&(e.innerHTML=m,e.classList.remove("logged-in"))}}

function D(){const p=localStorage.getItem("prompt_dismissed_v13");const q=Date.now();if(!p){E();return}try{const r=JSON.parse(p);const s=(q-r.timestamp)/(1e3*60*60*24);if(s<3.5)return;E()}catch(p){console.error("Error parsing dismissal data:",p),E()}}

function E(){const p="undefined"!=typeof data&&data.blog?.title?data.blog.title:"صوانˣʸᶻ",q="undefined"!=typeof data&&data.blog?.blogspotFaviconUrl?data.blog.blogspotFaviconUrl:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh80X00Lvdk3ZJBmgQFmGd1SmDZvqHpPf8D6YhmW7QsWYXyo_Cbo6BFHHdv1r1ocOe4gr5OexjPYYi-9Tp6QFQsfci2WPbFDu6DGFFr4UzhyphenhyphenkbTKFEBEQyPPbuYDM08v9-OU4ySBsI4bNOPtqr-U1fKMmcqRL38XSVE_XvVjFcblgVffq1j18GvYQTZEM8/s1600/favicon.png";let r=document.getElementById("login-signup-prompt-dynamic");if(r)return;const s=document.createElement("div");s.innerHTML=`<div id="login-signup-prompt-dynamic" class="browser-notification-bar"><div class="prompt-content"><div class="site-info"><img src="${q}" alt="${p} icon" class="site-icon"/><div class="text-block"><p class="site-name">${p}</p><p class="prompt-message">هل أنت جديد هنا؟ سجل الدخول أو أنشئ حسابًا.</p></div></div><div dir="ltr" class="prompt-actions"><a href="/p/login.html" class="action-button">تسجيل الدخول</a><button id="dismiss-prompt-dynamic" class="secondary-button">ليس الآن</button></div></div></div>`.trim(),r=s.firstElementChild,document.body.appendChild(r);const t=document.getElementById("dismiss-prompt-dynamic");setTimeout(()=>{r.style.display="block",setTimeout(()=>{r.classList.add("show")},50)},5e3),t.addEventListener("click",()=>{r.classList.remove("show"),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},400);const p={timestamp:q,version:"v13"};localStorage.setItem("prompt_dismissed_v13",JSON.stringify(p))},{once:!0})}

function F(){e&&d&&(e.style.cursor="pointer",e.addEventListener("click",p=>{p.preventDefault(),d.checked=!d.checked})),document.addEventListener("click",p=>{const q=p.target;d&&d.checked&&e&&f&&!e.contains(q)&&!f.contains(q)&&(d.checked=!1)}),j&&(j.style.cursor="pointer",j.addEventListener("click",()=>window.location.href="/p/admin.html")),l&&(l.style.cursor="pointer",l.addEventListener("click",p=>{p.preventDefault(),window.location.href="/p/points.html"})),m&&(m.style.cursor="pointer",m.addEventListener("click",p=>{p.preventDefault(),window.location.href="/p/my-products.html"}))}

document.addEventListener("DOMContentLoaded",()=>{d=document.getElementById("forlogPop"),e=document.querySelector(".logReg"),f=document.querySelector(".logPop-wrp"),h=document.querySelector(".NotLog"),i=document.querySelector(".DonLog"),i&&(j=i.querySelector('div.loginS[aria-label="ادمن"]'),l=i.querySelector('a.loginS[aria-label="نقاطي"]'),k=i.querySelector('div.loginS[aria-label="الخروج"]'),m=i.querySelector('a.loginS[aria-label="منتجاتي"]')),m=e?e.innerHTML:"",F(),o()});
