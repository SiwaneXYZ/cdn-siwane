const FPK='firebaseUserProfileData',DPI='https://cdn-icons-png.flaticon.com/512/3135/3135715.png',FV='11.6.1';
let auth,app,init,loginChk,userIcon,popup,notLog,logDiv,adminEl,pointsEl,logoutEl,productsEl,origHtml;

function getConfig(){const e=document.getElementById("json:firebaseconfig");if(!e)return null;try{const t=JSON.parse(e.textContent);return t&&t.apiKey&&(t.appId||t.projectId)?t:null}catch(e){return null}}

async function initFirebase(){if(init)return;const e=getConfig();if(!e)return updateUI(!1),showPrompt(),void(loginChk&&(loginChk.checked=!1));try{const[t,n]=await Promise.all([import(`https://www.gstatic.com/firebasejs/${FV}/firebase-app.js`),import(`https://www.gstatic.com/firebasejs/${FV}/firebase-auth.js`)]);const{initializeApp:i,getApps:o,getApp:r}=t,{getAuth:s,onAuthStateChanged:a,signOut:c}=n;const l=o();app=l.length?r():i(e),auth=s(app),init=!0,a(auth,e=>{e?handleLogin(e):handleLogout(),loginChk&&(loginChk.checked=!1)})}catch(e){updateUI(!1),showPrompt(),loginChk&&(loginChk.checked=!1)}}

function handleLogin(e){const t={uid:e.uid,displayName:e.displayName,photoURL:e.photoURL,email:e.email};let n=null;try{const e=localStorage.getItem(FPK);n=e?JSON.parse(e):null}catch(e){}const i={...n,...t,isAdmin:n?n.isAdmin:!1};localStorage.setItem(FPK,JSON.stringify(i)),updateUI(!0,i,i.photoURL||e.photoURL)}

function handleLogout(){localStorage.removeItem(FPK),updateUI(!1),showPrompt()}

function updateUI(e,t,n){if(!notLog||!logDiv)return;if(e){notLog.classList.add("hidden"),logDiv.classList.remove("hidden");const e=t&&!0===t.isAdmin;adminEl&&adminEl.classList.toggle("hidden",!e),pointsEl&&pointsEl.classList.toggle("hidden",e),productsEl&&productsEl.classList.toggle("hidden",e),userIcon&&updateProfileImg(n)}else{notLog.classList.remove("hidden"),logDiv.classList.add("hidden"),adminEl&&adminEl.classList.add("hidden"),pointsEl&&pointsEl.classList.add("hidden"),productsEl&&productsEl.classList.add("hidden"),userIcon&&resetProfileImg()}}

function updateProfileImg(e){const t=userIcon.querySelector(".current-profile-image")||function(){const e=document.createElement("img");return e.alt="Profile",e.classList.add("profileUser","current-profile-image"),e.onerror=function(){this.src=DPI},userIcon.innerHTML="",userIcon.appendChild(e),e}();t.src=e||DPI,userIcon.classList.add("logged-in")}

function resetProfileImg(){userIcon.innerHTML=origHtml,userIcon.classList.remove("logged-in")}

function showPrompt(){const e=localStorage.getItem("prompt_dismissed_v13");if(e)try{const t=JSON.parse(e);if((Date.now()-t.timestamp)/864e5<3.5)return}catch(e){}addPromptCSS();const t="undefined"!=typeof data&&data.blog?.title?data.blog.title:"صوانˣʸᶻ",n="undefined"!=typeof data&&data.blog?.blogspotFaviconUrl?data.blog.blogspotFaviconUrl:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh80X00Lvdk3ZJBmgQFmGd1SmDZvqHpPf8D6YhmW7QsWYXyo_Cbo6BFHHdv1r1ocOe4gr5OexjPYYi-9Tp6QFQsfci2WPbFDu6DGFFr4UzhyphenhyphenkbTKFEBEQyPPbuYDM08v9-OU4ySBsI4bNOPtqr-U1fKMmcqRL38XSVE_XvVjFcblgVffq1j18GvYQTZEM8/s1600/favicon.png";let i=document.getElementById("login-signup-prompt-dynamic");i||(i=function(){const e=document.createElement("div");return e.innerHTML=`<div id="login-signup-prompt-dynamic" class="browser-notification-bar"><div class="prompt-content"><div class="site-info"><img src="${n}" alt="${t}" class="site-icon"><div class="text-block"><p class="site-name">${t}</p><p class="prompt-message">هل أنت جديد هنا؟ سجل الدخول أو أنشئ حسابًا.</p></div></div><div dir="ltr" class="prompt-actions"><a href="/p/login.html" class="action-button">تسجيل الدخول</a><button id="dismiss-prompt-dynamic" class="secondary-button">ليس الآن</button></div></div></div>`,document.body.appendChild(e.firstElementChild),e.firstElementChild}());const o=document.getElementById("dismiss-prompt-dynamic");setTimeout(()=>{i.style.display="block",setTimeout(()=>i.classList.add("show"),50)},2e3),o.addEventListener("click",()=>{i.classList.remove("show"),setTimeout(()=>{i.style.display="none"},400),localStorage.setItem("prompt_dismissed_v13",JSON.stringify({timestamp:Date.now(),version:"v13"}))},{once:!0})}

// 🔥 هذه الدالة كانت مفقودة في الكود المضغوط!
function addPromptCSS(){if(document.getElementById("prompt-css"))return;const e=document.createElement("style");e.id="prompt-css",e.textContent=`:root{--clr-action-primary:var(--linkC,#007aff);--clr-text-secondary:#6a6a6a}.browser-notification-bar{--clr-bg:rgba(255,255,255,0.98);--clr-text:#1a1a1a;--clr-border:rgba(0,0,0,0.1);background-color:var(--clr-bg);box-shadow:none;border:1px solid var(--clr-border);color:var(--clr-text)}.drK .browser-notification-bar{--clr-bg:rgba(30,30,30,0.98);--clr-text:#f0f0f0;--clr-border:rgba(255,255,255,0.15);background-color:var(--clr-bg);box-shadow:none;border:1px solid var(--clr-border);color:var(--clr-text)}.browser-notification-bar{position:fixed;top:58px;left:0;right:0;margin:0 auto;z-index:10000;max-width:650px;width:95%;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);border-radius:8px;padding:18px;display:none;font-family:system-ui,sans-serif;direction:rtl;transform:translate(0,-100%);opacity:0;transition:opacity 0.4s cubic-bezier(0.25,0.1,0.25,1),transform 0.4s cubic-bezier(0.25,0.1,0.25,1)}.browser-notification-bar.show{opacity:1;transform:translate(0,0)}.prompt-content{display:flex;justify-content:space-between;align-items:center}.site-info{display:flex;align-items:center;flex-grow:1;min-width:0}.site-name{font-size:0.95em;font-weight:600;margin:0 0 2px 0;color:var(--clr-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.site-icon{width:32px;height:32px;border-radius:8px;margin-inline-end:12px;object-fit:contain;flex-shrink:0}.text-block{display:flex;flex-direction:column;min-width:0;text-align:right}.prompt-message{font-size:0.85em;color:var(--clr-text-secondary);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.35}.prompt-actions{display:flex;justify-content:flex-start;align-items:center;gap:10px;flex-shrink:0}.action-button{background-color:var(--clr-action-primary);color:white;padding:9px 16px;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.9em;flex-shrink:0;white-space:nowrap;transition:background-color 0.2s}.secondary-button{background:none;border:none;color:var(--clr-text-secondary);padding:9px 16px;font-size:0.9em;cursor:pointer;transition:all 0.3s ease;opacity:0.8;white-space:nowrap;border-radius:8px;line-height:1;position:relative;overflow:hidden}.secondary-button::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background-color:var(--clr-text-secondary);opacity:0;border-radius:8px;transition:opacity 0.3s ease;z-index:-1}.secondary-button:hover::before{opacity:0.1}.secondary-button:hover{opacity:1;transform:translateY(-1px)}.secondary-button:active{transform:translateY(0)}@media (max-width:500px){.browser-notification-bar{width:98%;padding:10px}.site-name{font-size:0.85em}.prompt-message{font-size:0.75em}.action-button{padding:7px 10px;font-size:0.8em}.secondary-button{font-size:0.8em;padding:7px 0}}`,document.head.appendChild(e)}

function setupEvents(){userIcon&&loginChk&&(userIcon.style.cursor="pointer",userIcon.addEventListener("click",e=>{e.preventDefault(),loginChk.checked=!loginChk.checked})),document.addEventListener("click",e=>{const t=e.target;loginChk&&loginChk.checked&&userIcon&&popup&&!userIcon.contains(t)&&!popup.contains(t)&&(loginChk.checked=!1)}),adminEl&&(adminEl.style.cursor="pointer",adminEl.addEventListener("click",()=>{window.location.href="/p/admin.html"})),pointsEl&&(pointsEl.style.cursor="pointer",pointsEl.addEventListener("click",e=>{e.preventDefault(),window.location.href="/p/points.html"})),productsEl&&(productsEl.style.cursor="pointer",productsEl.addEventListener("click",e=>{e.preventDefault(),window.location.href="/p/my-products.html"})),logoutEl&&(logoutEl.style.cursor="pointer",logoutEl.addEventListener("click",()=>{auth?import(`https://www.gstatic.com/firebasejs/${FV}/firebase-auth.js`).then(e=>{e.signOut(auth).then(()=>{localStorage.removeItem(FPK),updateUI(!1),window.location.href="/p/login.html"})}):(localStorage.removeItem(FPK),updateUI(!1),window.location.href="/p/login.html")}))}

document.addEventListener("DOMContentLoaded",()=>{loginChk=document.getElementById("forlogPop"),userIcon=document.querySelector(".logReg"),popup=document.querySelector(".logPop-wrp"),notLog=document.querySelector(".NotLog"),logDiv=document.querySelector(".DonLog"),logDiv&&(adminEl=logDiv.querySelector('div.loginS[aria-label="ادمن"]'),logoutEl=logDiv.querySelector('div.loginS[aria-label="الخروج"]'),pointsEl=logDiv.querySelector('a.loginS[aria-label="نقاطي"]'),productsEl=logDiv.querySelector('a.loginS[aria-label="منتجاتي"]')),origHtml=userIcon?userIcon.innerHTML:"",setupEvents(),initFirebase()});
