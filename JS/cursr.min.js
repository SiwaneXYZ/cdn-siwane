(function() {
  document.addEventListener('DOMContentLoaded', function() {

    // دالة لحل اللون الفعلي من CSS variable أو اللون مباشرة
    function resolveColor(color) {
      if(color.startsWith('var')) {
        return getComputedStyle(document.documentElement).getPropertyValue(color).trim();
      }
      return color;
    }

    // دالة توليد SVG المؤشر
    function generateCursor() {
      const border = resolveColor(cursor_config.cursor_border);
      const fill = resolveColor(cursor_config.cursor_color);

      let svg;
      if(cursor_config.custom_cursor) {
        svg = cursor_config.custom_svg;
      } else {
        svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" width="${cursor_config.cursor_width}" height="${cursor_config.cursor_height}">
          <path transform="scale(10.66667,10.66667)" d="M20.83,15.831c-0.12,0.41-0.47,0.71-0.89,0.77l-7.51,1.18l-5.63,4.66c-0.2,0.16-0.45,0.25-0.7,0.25c-0.16,0-0.32,-0.03-0.47,-0.11c-0.38,-0.18-0.63,-0.57-0.63,-0.99v-18.23c0,-0.43 0.26,-0.83 0.65,-1c0.39,-0.18 0.86,-0.11 1.18,0.18l13.68,12.15c0.31,0.29 0.44,0.73 0.32,1.14z"
            stroke="${border}" stroke-width="${cursor_config.border_width}" stroke-linejoin="round" fill="${fill}"/>
        </svg>`;
      }

      const cursorStyle = `url("data:image/svg+xml;utf8,${encodeURIComponent(svg)}"), auto`;
      let styleEl = document.querySelector('#dynamic-cursor-style');
      if(!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'dynamic-cursor-style';
        document.head.appendChild(styleEl);
      }
      styleEl.textContent = `* { cursor: ${cursorStyle} !important; }`;
    }

    // توليد المؤشر عند التحميل
    generateCursor();

    // مراقبة تغييرات --linkC كل 50ms لتحديث اللون فورًا
    let lastColor = resolveColor(cursor_config.cursor_color);
    setInterval(() => {
      const currentColor = resolveColor(cursor_config.cursor_color);
      if(currentColor !== lastColor) {
        lastColor = currentColor;
        generateCursor();
      }
    }, 50);

    // ===========================
    // clicker bubble
    // ===========================
    const transitionEvent = (function() {
      const el = document.createElement('fakeelement');
      const transitions = {
        'transition': 'transitionend',
        'OTransition': 'oTransitionEnd',
        'MozTransition': 'transitionend',
        'WebkitTransition': 'webkitTransitionEnd'
      };
      for(let t in transitions) if(el.style[t] !== undefined) return transitions[t];
    })();

    document.addEventListener('mousedown', function(e) {
      const r = document.createElement('div');
      r.className = 'clicker';
      r.style.left = e.pageX + "px";
      r.style.top = e.pageY + "px";
      r.style.background = resolveColor(cursor_config.clicker_color);
      r.style.width = "60px";
      r.style.height = "60px";
      r.style.marginLeft = "-30px";
      r.style.marginTop = "-30px";
      r.style.borderRadius = "100%";
      r.style.position = "absolute";
      r.style.transform = "scale(0)";
      r.style.opacity = ".3";
      r.style.zIndex = "9999";
      r.style.pointerEvents = "none";
      document.body.appendChild(r);

      setTimeout(function() {
        r.addEventListener(transitionEvent, function() {
          if(document.body.contains(r)) document.body.removeChild(r);
        });
        r.className += ' is-active';
        r.style.transform = 'scale(1)';
        r.style.transition = 'opacity .9s, transform .9s';
        r.style.opacity = '0';
      }, 0);
    });

  });

  console.log('Custom Cursor + Clicker Bubble v1.5 Initialized (dynamic color)');

})();
