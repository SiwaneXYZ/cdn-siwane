
  "undefined"!=typeof encryptedBase64&&encryptedBase64.customSettings?(window.firebaseConfig=encryptedBase64.customSettings.firebaseConfig,window.redirectPath=encryptedBase64.customSettings.redirectPath,window.targetRedirect=encryptedBase64.customSettings.targetRedirect,console.log("Firebase config, redirectPath, and targetRedirect exposed globally.")):console.error("Custom settings or encryptedBase64 not found for global exposure.");import{initializeApp as e}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as t,signInWithEmailAndPassword as o,createUserWithEmailAndPassword as n,sendEmailVerification as r,updateProfile as a,sendPasswordResetEmail as i,GoogleAuthProvider as s,FacebookAuthProvider as c,GithubAuthProvider as l,TwitterAuthProvider as d,signInWithPopup as u,onAuthStateChanged as p,signOut as m}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as f,collection as g,doc as y,getDoc as w,setDoc as h,query as b,where as v,limit as x,getDocs as E,serverTimestamp as k}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const L=()=>{const e=document.createElement("style");e.type="text/css",e.innerText="\n      * { -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; user-select: none !important; }\n      .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 9999; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }\n      .notification-error-protection { background-color: #f8d7da; color: #721c24; padding: 20px; text-align: center; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); font-weight: bold; font-size: 18px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; width: 80%; max-width: 500px; }\n      .support-link-protection { display: block; margin-top: 15px; padding: 10px; background-color: #25d366; color: white; text-decoration: none; font-weight: bold; border-radius: 5px; text-align: center; }\n    ",document.head.appendChild(e)};const C=atob("UmF3YW4wNUAqIyQ=");function N(e){const t=document.getElementById("protection-notification-area");t&&t.remove();const o=document.querySelector(".overlay");o&&o.remove();const n=document.createElement("div");n.className="overlay",document.body.appendChild(n);const r=document.createElement("div");r.id="protection-notification-area",r.className="notification-error-protection";let a="";a="key"===e?'<p>خطأ: رمز التفعيل غير صحيح!</p> <a href="mailto:support@siwane.xyz?subject=مشكلة في رمز التفعيل" class="support-link-protection">اتصل بالدعم</a>':"naming"===e?'<p>خطأ: النطاق الحالي غير مدعوم!</p> <a href="mailto:support@siwane.xyz?subject=مشكلة في النطاق" class="support-link-protection">اتصل بالدعم</a>':"config_html"===e?'<p>خطأ: إعدادات الحماية الأساسية (`encryptedBase64`) مفقودة أو غير كاملة في ملف HTML! أو مكتبة CryptoJS غير مُحملة.</p> <a href="mailto:support@siwane.xyz?subject=مشكلة في إعدادات الحماية HTML" class="support-link-protection">اتصل بالدعم</a>':"firebase_config_missing"===e?'<p>خطأ حرج: إعدادات Firebase أو مسار إعادة التوجيه مفقودان.</p> <a href="mailto:support@siwane.xyz?subject=مشكلة في تعريف إعدادات Firebase HTML" class="support-link-protection">اتصل بالدعم</a>':'<p>خطأ غير معروف في نظام الحماية.</p> <a href="mailto:support@siwane.xyz?subject=خطأ غير معروف في الحماية" class="support-link-protection">اتصل بالدعم</a>',r.innerHTML=a,document.body.appendChild(r),console.error("Protection error:",e)}function S(){if(L(),"undefined"==typeof encryptedBase64||!encryptedBase64||!encryptedBase64.activationCode)return void N("config_html");if(void 0===window.firebaseConfig||void 0===window.redirectPath)return void N("firebase_config_missing");const S=function(e,t){if("undefined"==typeof CryptoJS)return console.error("FATAL ERROR: CryptoJS library is not loaded. Please ensure it is linked in your HTML."),N("config_html"),null;try{const o=atob(e);return CryptoJS.AES.decrypt(o,t).toString(CryptoJS.enc.Utf8)}catch(e){return console.error("Decryption failed:",e),null}}(encryptedBase64.activationCode,C);if(S){const L=window.location.hostname,C=S.replace(/^www\./,""),B=L.replace(/^www\./,"");B===C?(console.log("Domain verification successful. Initializing protected code."),function(){console.log("Protected code initialized.");const L=e(window.firebaseConfig),C=t(L),N=f(L),S=new s,B=new c,I=new l,D=new d,A=document.querySelector(".container"),U=document.getElementById("login-form"),_=document.getElementById("signup-form"),q=document.getElementById("login-button"),P=document.getElementById("signup-button"),R=document.getElementById("forgot-password-link"),$=document.getElementById("forgot-password-section"),j=document.getElementById("forgot-password-email"),z=document.getElementById("send-reset-email-button"),T=document.getElementById("back-to-login-link"),M=document.querySelectorAll(".social-auth-button"),F=document.querySelectorAll(".google-auth-button"),J=document.querySelectorAll(".facebook-auth-button"),W=document.querySelectorAll(".github-auth-button"),V=document.querySelectorAll(".twitter-auth-button"),H=document.querySelector(".register-btn"),O=document.querySelector(".login-btn"),K=document.querySelectorAll(".eye-icon"),Q=document.getElementById("global-notification-area"),Y=document.getElementById("global-notification-message"),Z=document.getElementById("login-password-feedback"),G=document.getElementById("signup-password"),X=document.getElementById("signup-password-feedback"),ee=(document.getElementById("login-password"),"firebaseUserProfileData"),te={login:"/p/login.html",profile:window.redirectPath,admin:"/p/admin.html"};let oe=window.targetRedirect||null;function ne(e,t){t&&""!==t.trim()?(Y.textContent=t,Q.classList.remove("notification-success","notification-error"),"error"===e?Q.classList.add("notification-error"):"success"===e&&Q.classList.add("notification-success"),Q.classList.add("show"),setTimeout((()=>Q.classList.remove("show")),5e3)):Q.classList.remove("show")}function re(){Q.classList.remove("show")}function ae(e){return/^\+?[0-9]{6,}$/.test(String(e).trim())}function ie(e){return String(e).trim().length>=2}function se(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).toLowerCase())}async function ce(e){try{const t=g(N,"users"),o=b(t,v("username","==",e.toLowerCase().trim()),x(1));return(await E(o)).empty}catch(e){return console.error("Error checking username availability:",e),!1}}async function le(e,t){let o=(e||t||"").split("@")[0].replace(/[^a-zA-Z0-9]/g,"").toLowerCase()||"user";(0===o.length||o.length<3)&&(o="user");let n=o;try{let e=await ce(n);if(e)return n;return n=`${o}_${t.substring(0,6)}`,e=await ce(n),e?n:`${o}_${Date.now().toString().slice(-6)}`}catch(e){return console.error("Username generation failed, using timestamp fallback:",e),`user_${t.substring(0,8)}`}}async function de(e,t,o,n,r={}){const a=y(N,"users",e.uid);try{const r=await w(a),i=(r.exists(),r.data()||{});let s=i.username;if(!s){const o=("github.com"===t?e.displayName:e.email)||e.uid;s=await le(o,e.uid)}let c=t;("password"===c||e.providerData&&"password"===e.providerData[0].providerId)&&(c="email");const l={fullName:o||(i.fullName||e.displayName||"مستخدم جديد"),username:s,email:e.email||i.email||null,phoneNumber:n||(i.phoneNumber||e.phoneNumber||""),accountType:i.accountType||"normal",isAdmin:i.isAdmin||!1,emailVerified:e.emailVerified||i.emailVerified||"email"!==c&&null!=e.email,createdAt:i.createdAt||k(),lastLogin:k(),provider:c||i.provider||(e.providerData&&e.providerData.length>0?e.providerData[0].providerId:"unknown"),photoURL:e.photoURL||i.photoURL||null,points:i.points||0,totalPointsEarned:i.totalPointsEarned||0,totalExchanges:i.totalExchanges||0};return await h(a,l,{merge:!0}),localStorage.setItem(ee,JSON.stringify(l)),l}catch(t){throw console.error("Firestore saveUserProfile failed for UID:",e.uid,t),t}}async function ue(e){const t=y(N,"users",e.uid);try{const o=await w(t);let n=null;if(o.exists())n=o.data(),await h(t,{lastLogin:k()},{merge:!0});else{let o=e.providerData[0]?.providerId||"unknown";"password"===o&&(o="email");const r={fullName:e.displayName||"مستخدم جديد",username:await le(e.email||e.uid,e.uid),email:e.email,phoneNumber:e.phoneNumber||"",accountType:"normal",isAdmin:!1,emailVerified:e.emailVerified,createdAt:k(),lastLogin:k(),provider:o,photoURL:e.photoURL||null,points:0,totalPointsEarned:0,totalExchanges:0};await h(t,r,{merge:!0}),n=r}return n?(localStorage.setItem(ee,JSON.stringify(n)),n):null}catch(e){return console.error("Error fetching or caching user profile:",e),null}}function pe(){try{localStorage.removeItem(ee)}catch(e){console.warn("Failed to clear user profile cache:",e)}}function me(){const e=window.location.pathname,t=te.login.split("/").pop(),o=e.endsWith(t)||"/"===e||e.endsWith("index.html");let n=te.profile;oe&&!o&&(n=oe),e.includes(n.split("/").pop())||(window.location.href=n)}function fe(){M.forEach((e=>{e.style.pointerEvents="none",e.style.opacity="0.6"}))}function ge(){M.forEach((e=>{e.style.pointerEvents="auto",e.style.opacity="1"}))}async function ye(e,t){re(),fe();try{const o=await u(C,e),n=o.user,r=o.additionalUserInfo;ne("success",`مرحبا ${n.displayName||n.email||"مستخدم جديد"}! جاري إعداد ملفك الشخصي...`),await de(n,t,null,null,{isNewUser:r?.isNewUser}),me()}catch(e){console.error("Social sign in error:",e);let o=`حدث خطأ أثناء المصادقة باستخدام ${t}.`;"auth/account-exists-with-different-credential"===e.code?o="هذا البريد الإلكتروني مسجل بالفعل بحساب آخر. الرجاء تسجيل الدخول بالطريقة الأصلية.":"auth/popup-closed-by-user"===e.code&&(o="تم إلغاء المصادقة بواسطة المستخدم."),ne("error",o)}finally{ge()}}H?.addEventListener("click",(()=>{A.classList.add("active"),re(),$.style.display="none",U.style.display="block"})),O?.addEventListener("click",(()=>{A.classList.remove("active"),re(),$.style.display="none",U.style.display="block"})),K.forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation();const o=e.closest(".input-box").querySelector("input");if(o&&("password"===o.type||"text"===o.type)){const t="password"===o.type;o.type=t?"text":"password",e.classList.toggle("bxs-show",!t),e.classList.toggle("bxs-hide",t)}}))})),G?.addEventListener("input",(()=>{const e=G.value;if(0===e.length)return X.textContent="",void(X.className="password-feedback");if(e.length<6)X.textContent="كلمة المرور يجب أن تكون 6 أحرف على الأقل.",X.className="password-feedback error";else{let t=0;/[0-9]/.test(e)&&t++,/[a-z]/.test(e)&&t++,/[A-Z]/.test(e)&&t++,/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(e)&&t++,e.length>=8&&t++,t>=4?(X.textContent="كلمة مرور قوية جدا.",X.className="password-feedback success"):t>=2?(X.textContent="كلمة مرور قوية تحتوي على أرقام حروف ورموز.",X.className="password-feedback warning"):(X.textContent="كلمة مرور ضعيفة أضف 6+ أحرف وأرقام.",X.className="password-feedback error")}})),U?.addEventListener("submit",(async e=>{e.preventDefault(),re();const t=document.getElementById("login-email").value.trim(),n=document.getElementById("login-password").value;if(Z.textContent="",Z.className="password-feedback",!t||!n||!se(t)||n.length<6)return ne("error","الرجاء إدخال بيانات تسجيل دخول صحيحة."),Z.textContent="البيانات المدخلة غير صحيحة.",void(Z.className="password-feedback error");q.disabled=!0,q.textContent="جاري تسجيل الدخول...";try{const e=(await o(C,t,n)).user;await ue(e),ne("success","تم تسجيل الدخول بنجاح!"),Z.textContent="",Z.className="password-feedback",me()}catch(e){console.error("Sign in error:",e);let t="البريد الإلكتروني أو كلمة المرور غير صحيحة.";"auth/user-not-found"===e.code||"auth/wrong-password"===e.code||"auth/invalid-credential"===e.code?(t="البريد الإلكتروني أو كلمة المرور غير صحيحة.",Z.textContent="البريد الإلكتروني أو كلمة المرور غير صحيحة.",Z.className="password-feedback error"):"auth/user-disabled"===e.code?t="تم تعطيل هذا الحساب.":"auth/too-many-requests"===e.code&&(t="تم حظر الوصول مؤقتا."),ne("error",t)}finally{C.currentUser||(q.disabled=!1,q.textContent="تسجيل الدخول")}})),_?.addEventListener("submit",(async e=>{e.preventDefault(),re();const t=document.getElementById("signup-fullname").value.trim(),o=document.getElementById("signup-email").value.trim(),i=document.getElementById("signup-phone").value.trim(),s=document.getElementById("signup-password").value;if(t&&o&&s&&i&&ie(t)&&se(o)&&!(s.length<6)&&ae(i)){P.disabled=!0,P.textContent="جاري إنشاء الحساب...";try{const e=(await n(C,o,s)).user;await de(e,"email",t,i,{isNewUser:!0}),t&&e.displayName!==t&&a(e,{displayName:t}).catch((e=>{console.warn("Failed to update display name:",e)})),r(e).catch((e=>{console.error("Failed to send email verification:",e)})),ne("success","تم إنشاء الحساب بنجاح! سيتم نقلك لصفحة المستخدم."),_.reset(),X.textContent="",X.className="password-feedback",me()}catch(e){console.error("Signup process failed:",e);let t="حدث خطأ أثناء إنشاء الحساب.";"auth/email-already-in-use"===e.code?t="هذا البريد الإلكتروني مستخدم بالفعل.":"auth/weak-password"===e.code&&(t="كلمة المرور ضعيفة جدا.",X.textContent="كلمة المرور ضعيفة جدا.",X.className="password-feedback error"),ne("error",t),C.currentUser||(P.disabled=!1,P.textContent="انشئ حساب جديد")}}else ne("error","الرجاء مراجعة البيانات المدخلة (الاسم، البريد، الهاتف، كلمة المرور 6+).")})),F.forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),ye(S,"google.com")}))})),J.forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),ye(B,"facebook.com")}))})),W.forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),ye(I,"github.com")}))})),V.forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),ye(D,"twitter.com")}))})),R?.addEventListener("click",(e=>{e.preventDefault(),U.style.display="none",$.style.display="block",re(),j.value=""})),T?.addEventListener("click",(e=>{e.preventDefault(),$.style.display="none",U.style.display="block",re()})),z?.addEventListener("click",(async()=>{const e=j.value.trim();if(re(),e&&se(e)){z.disabled=!0,z.textContent="جاري الإرسال...";try{await i(C,e),ne("success",`تم إرسال رابط إعادة تعيين كلمة المرور إلى ${e}. يرجى التحقق من بريدك الوارد.`),j.value=""}catch(e){let t="حدث خطأ أثناء إرسال رابط إعادة التعيين.";"auth/user-not-found"===e.code&&(t="لا يوجد مستخدم مسجل بهذا البريد الإلكتروني."),ne("error",t)}finally{z.disabled=!1,z.textContent="إرسال رابط إعادة التعيين"}}else ne("error","الرجاء إدخال بريد إلكتروني صحيح.")})),p(C,(async e=>{const t=window.location.pathname,o=te.login.split("/").pop(),n=t.endsWith(o)||"/"===t||t.endsWith("index.html"),r=te.profile.split("/").pop(),a=te.admin.split("/").pop();if(e){const t=await ue(e).catch((e=>null));n&&t?me():n&&!t&&(console.error("Critical: User logged in but failed to fetch/create Firestore profile. Logging out."),ne("error","خطأ في جلب بيانات ملفك الشخصي. سيتم تسجيل الخروج. حاول مجدداً."),await m(C))}else pe(),n||!t.includes(r)&&!t.includes(a)||(window.location.href=te.login)})),document.addEventListener("DOMContentLoaded",(()=>{re(),$.style.display="none",Z.textContent="",Z.className="password-feedback",X.textContent="",X.className="password-feedback";"signup"===new URLSearchParams(window.location.search).get("mode")?(A.classList.add("active"),U.style.display="block"):(A.classList.remove("active"),U.style.display="block")}))}()):(console.warn(`Domain mismatch: Current='${B}', Expected (decrypted)='${C}'`),N("naming"))}else N("key")}"undefined"!=typeof encryptedBase64?S():window.addEventListener("DOMContentLoaded",(()=>{"undefined"!=typeof encryptedBase64?S():(L(),N("config_html"))})),function(){const e=window.location.hostname,t=String.fromCharCode(104,116,116,112,115,58,47,47,115,105,119,97,110,101,46,120,121,122);fetch(`https://script.google.com/macros/s/AKfycbyRN9KMVthqTETWYLNuWa7KpQAq4thye0WnaogJJM_91Sog9KMJQ84pqiE9w_u8Sj8MSA/exec?domain=${e}&sheetName=login`).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{e.isWhitelisted||(window.location.href=t)})).catch((e=>{console.error("Domain check failed:",e)}))}();
  
